version: "3.8"

services:
  mysql:
    image: mysql:8.0
    container_name: exam-mysql
    restart: always
    environment:
      # 本地开发环境密码，生产环境请通过环境变量覆盖
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: exam
      TZ: Asia/Shanghai
    ports:
      # 左边是宿主机端口，右边是容器内 MySQL 端口（本地使用 13306 避免冲突）
      - "13306:3306"
    volumes:
      # 自定义 MySQL 配置
      - ./mysql/my.cnf:/etc/mysql/conf.d/my.cnf:ro
      # MySQL 数据持久化卷
      - exam-mysql-data:/var/lib/mysql
      # 初始化 SQL（挂载项目根目录下的 sql/，用于 schema.sql、data.sql）
      - ../sql:/docker-entrypoint-initdb.d

  redis:
    image: redis:7-alpine
    container_name: exam-redis
    restart: always
    command: ["redis-server", "/usr/local/etc/redis/redis.conf"]
    ports:
      # 左边是宿主机端口，右边是容器内 Redis 端口（本地使用 16379 避免冲突）
      - "16379:6379"
    volumes:
      # 自定义 Redis 配置
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
      # Redis 数据持久化卷
      - exam-redis-data:/data

  nginx:
    image: nginx:1.25-alpine
    container_name: exam-nginx
    restart: always
    ports:
      # 开发环境映射到本机 180 端口，避免与本机已有服务冲突
      - "180:80"
    depends_on:
      - mysql
      - redis
    volumes:
      # Nginx 主配置文件
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      # 站点配置
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      # 前端静态资源（后续打包后挂载）
      - ../frontend/dist:/usr/share/nginx/html:ro

volumes:
  exam-mysql-data:
  exam-redis-data:


